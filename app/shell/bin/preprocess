#!/usr/bin/env bash

# preprocess
# Expand includes, render links, and substitute emoji in Markdown files.

set -euo pipefail

VERBOSE="${VERBOSE:-0}"
(( VERBOSE )) && set -x

process_file() {
    local input="$1"
    # strip leading src/ if present, then prefix with build/
    local relpath="${input#src/}"
    local output="build/${relpath}"

    # ensure build directory exists
    mkdir -p "$(dirname "$output")"

    # Include and process Markdown files up to three levels deep
    for _ in 1 2 3; do
        include-filter build "$input" "$output"
    done

    # Render links using metadata from Redis
    render-jinja-template "$output" "$output.$$"
    mv "$output.$$" "$output"
    (( VERBOSE )) && cat "$output"

    # run emojify, write to a temp file and atomically move
    emojify < "$output" > "$output.tmp"
    mv "$output.tmp" "$output"
}

usage() {
    echo "Usage: $0 <markdown-file>..." >&2
}

main() {
    if [[ $# -lt 1 ]]; then
        usage
        exit 1
    fi

    for md in "$@"; do
        process_file "$md"
    done
}

main "$@"
