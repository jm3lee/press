#!/usr/bin/env bash
# Generate a sitemap.xml file from HTML files in a directory.
# Usage: sitemap [DIRECTORY] [BASE_URL]
# If DIRECTORY is not provided, defaults to build/.
# BASE_URL may also be provided through the BASE_URL environment variable.
set -euo pipefail

BUILD_DIR="${1:-build}"
BASE_URL="${2:-${BASE_URL:-}}"

if [[ -z "$BASE_URL" ]]; then
  echo "Usage: sitemap [DIRECTORY] BASE_URL" >&2
  exit 1
fi

# Strip trailing slash to avoid // in output.
BASE_URL="${BASE_URL%/}"

# Find all HTML files relative to BUILD_DIR.
mapfile -t files < <(find "$BUILD_DIR" -type f -name '*.html' | sed "s|^$BUILD_DIR/||" | sort)

{
  echo '<?xml version="1.0" encoding="UTF-8"?>'
  echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'
  for f in "${files[@]}"; do
    echo "  <url><loc>${BASE_URL}/${f}</loc></url>"
  done
  echo '</urlset>'
} > "$BUILD_DIR/sitemap.xml"
