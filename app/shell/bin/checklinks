#!/usr/bin/env bash

# checklinks
# Crawl a site and report broken links.

set -euo pipefail

LOG_DIR="log"
LOG_FILE="${LOG_DIR}/checklinks.txt"
PATTERN='broken link!!!|ERROR [45][0-9]{2}'

usage() {
    echo "Usage: $0 <url>" >&2
}

run_wget() {
    local url="$1"
    mkdir -p "$LOG_DIR"
    wget --spider \
        --recursive \
        --no-directories \
        --level=3 \
        --hsts-file=/dev/null \
        "$url" 2>&1 | tee "$LOG_FILE"
    return "${PIPESTATUS[0]}"
}

main() {
    if [[ $# -ne 1 ]]; then
        usage
        exit 1
    fi

    local status=0
    run_wget "$1" || status=$?

    if grep -Eq "$PATTERN" "$LOG_FILE"; then
        status=1
    fi

    if (( status != 0 )); then
        echo "Broken links detected" >&2
    else
        echo "No broken links found."
    fi

    return "$status"
}

main "$@"
